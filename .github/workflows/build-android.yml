name: Build Android Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allow manual triggering

env:
  APP_NAME: "Pick Up Form"
  VERSION: "2.2.0"
  JAVA_VERSION: '11'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          openjdk-11-jdk \
          python3-pip \
          python3-venv \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          zip \
          unzip
    
    - name: Install Python packages
      run: |
        pip install --upgrade pip
        pip install briefcase==0.5.2
        pip install toga-android==0.5.2
        pip install -r requirements.txt
    
    - name: Create Android project
      run: |
        briefcase create android
    
    - name: Build Android app
      run: |
        briefcase build android
    
    - name: Package as AAB
      run: |
        briefcase package android --package-format=aab
    
    - name: Download bundletool
      run: |
        wget -q https://github.com/google/bundletool/releases/download/1.18.2/bundletool-all-1.18.2.jar
        echo "BUNDLETOOL_PATH=$(pwd)/bundletool-all-1.18.2.jar" >> $GITHUB_ENV
    
    - name: Prepare keystore from secrets
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android-release-key.keystore
        echo "Keystore created:"
        keytool -list -v -keystore android-release-key.keystore \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -alias "${{ secrets.KEY_ALIAS }}" 2>/dev/null || true
    
    - name: Sign AAB
      run: |
        echo "Signing AAB file..."
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore android-release-key.keystore \
          "dist/${{ env.APP_NAME }}-${{ env.VERSION }}.aab" \
          "${{ secrets.KEY_ALIAS }}" \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.KEY_PASSWORD }}"
        
        echo "Verifying signature..."
        jarsigner -verify -verbose "dist/${{ env.APP_NAME }}-${{ env.VERSION }}.aab"
    
    - name: Generate APK from AAB
      run: |
        echo "Generating universal APK..."
        java -jar $BUNDLETOOL_PATH build-apks \
          --bundle="dist/${{ env.APP_NAME }}-${{ env.VERSION }}.aab" \
          --output="dist/${{ env.APP_NAME }}-${{ env.VERSION }}.apks" \
          --mode=universal \
          --ks=android-release-key.keystore \
          --ks-pass=pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
          --ks-key-alias="${{ secrets.KEY_ALIAS }}" \
          --key-pass=pass:"${{ secrets.KEY_PASSWORD }}"
        
        echo "Extracting APK..."
        unzip -j "dist/${{ env.APP_NAME }}-${{ env.VERSION }}.apks" "universal.apk" -d "dist/"
        mv "dist/universal.apk" "dist/${{ env.APP_NAME }}-${{ env.VERSION }}.apk"
        
        echo "Files generated:"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build-${{ github.ref_name }}
        path: |
          dist/*.aab
          dist/*.apk
        retention-days: 30
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          dist/*.aab
          dist/*.apk
        body: |
          # ${{ env.APP_NAME }} v${{ github.ref_name }}
          
          ## üì¶ Downloads
          - **AAB (Android App Bundle)**: For Google Play Store submission
          - **APK**: For direct installation on Android devices
          
          ## üöÄ Features
          - Dual-mode operation (Pickup & Delivery)
          - Professional PDF receipt generation
          - Route-based management
          - Company database synchronization
          
          ## üì± Installation
          1. Download the APK file
          2. On Android, enable "Install from unknown sources"
          3. Open the downloaded APK file
          4. Follow the installation prompts
          
          ## ‚öôÔ∏è Requirements
          - Android 5.0 (API 21) or higher
          - Storage permissions for PDF generation
          - Internet connection for synchronization
          
          ## üîí Security Note
          This APK is signed with a self-signed certificate. Android will show a warning about the app being from an unknown source. This is normal for apps not distributed through the Google Play Store.
          
          ## üìÑ License
          Copyright (c) 2025 Judah Yoder
          
          For personal, non-commercial use only.
          Contact for commercial licensing.